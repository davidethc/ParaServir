
 const login = async (req, res) => {
    try {
        // Obtener parametros
        const params = req.body;

        if (!params.email || !params.password) {
            return res.status(400).json({
                status: 'error',
                message: 'Ingrese la información necesaria'
            })
        }

        // Comprobar si existe en la bd
        const user = await User
            .findOne({ email: params.email.toLowerCase() })
            .select({ "__v": 0, "created_at": 0 });
        if (!user) {
            return res.status(400).json({
                status: 'error',
                message: 'Credenciales incorrectas'
            })
        }

        // Comprobar contraseña (versión asíncrona)
        const pwd = await bcrypt.compare(params.password, user.password);
        if (!pwd) {
            return res.status(400).json({
                status: 'error',
                message: 'Credenciales incorrectas'
            })
        }

        // Generar token
        const token = jwt.createToken(user);

        // Devolver informacion limitada
        return res.status(200).json({
            status: 'success',
            message: 'Bienvenido',
            user: {
                id: user._id,
                name: user.name,
                nickname: user.nickname,
                email: user.email,
                image: user.image
            },
            token
        })
    } catch (error) {
        return res.status(400).json({
            status: 'error',
            message: 'Error al iniciar sesion',
            error: error.message
        })
    }
}




jwt.js
const jwt = require("jwt-simple");
const moment = require("moment");

const secret =  "Barderos2005.";

const createToken = (user)=>{
    const payload = {
        id: user._id,
        name: user.name,
        surname: user.surname,
        nickname: user.nickname,
        email: user.email,
        role: user.role,
        image: user.image,
        iat:moment().unix(),
        exp:moment().add(30, "days").unix()
    }
    // Devolver jwt codificado
    return jwt.encode(payload, secret);
}

module.exports = {createToken, secret};


auth.js
const moment = require('moment');
const jwt = require("jwt-simple");
const libjwt = require("../services/jwt");

// Usar la exportación correcta desde services/jwt
const secret = libjwt.secret;

// Funcion middleware de autenticacion
exports.auth = (req, res, next) => {
    // Comprobar si me llega la cabecera de auth
    if (!req.headers.authorization) {
        return res.status(403).send({
            status: "error",
            message: "La peticion no tiene cabecera de autorizacion"
        })
    }
    // Limpiar token
    let token = req.headers.authorization.replace(/['"]+/g, '')
                                        .replace('Bearer ', '');

    // Decodificar token
    try {
        let payload = jwt.decode(token, secret);

        // Comprobar expiracion del token
        if (payload.exp <= moment().unix()) {
            return res.status(401).send({
                status: 'error',
                message: 'Token expirado'
            })
        }
        // Agregar datos del usuario a request
        req.user = payload;

    } catch (error) {
        // Token inválido -> 401 Unauthorized
        return res.status(401).send({
            status: 'error',
            message: 'Token invalido',
            error: error.message
        })
    }

    // Pasar a ejecucucion de accion
    next();

}